<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxim App Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard { display: none; } /* Hidden until logged in */
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-warning" href="#">üöñ Maxim Prototype</a>
            <div class="d-flex">
                <span id="userInfo" class="text-white me-3 align-self-center"></span>
                <button id="logoutBtn" class="btn btn-outline-warning btn-sm d-none" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">

        <div id="authSection">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h3 class="text-center mb-4">Welcome</h3>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="loginEmail" class="form-control" placeholder="name@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" id="loginPass" class="form-control" placeholder="******">
                        </div>
                        <button class="btn btn-warning w-100 fw-bold mb-3" onclick="login()">Login</button>
                        
                        <hr>
                        
                        <div class="text-center">
                            <small class="text-muted d-block mb-2">No account? Register as:</small>
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#regCustomerModal">Customer</button>
                                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#regDriverModal">Driver</button>
                                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#regAdminModal">Admin</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="customerDashboard" class="dashboard">
            <h2 class="mb-4">üëã Customer Panel</h2>
            <div class="row">
                <div class="col-md-5">
                    <div class="card p-4">
                        <h4>üìç Request a Ride</h4>
                        <div class="mb-3">
                            <label>Pickup</label>
                            <input type="text" id="pickup" class="form-control" placeholder="e.g. MMU Cyberjaya">
                        </div>
                        <div class="mb-3">
                            <label>Dropoff</label>
                            <input type="text" id="dropoff" class="form-control" placeholder="e.g. D'Pulze Mall">
                        </div>
                        <div class="mb-3">
                            <label>Distance (KM)</label>
                            <input type="number" id="distance" class="form-control" value="5">
                        </div>
                        <button class="btn btn-primary w-100" onclick="requestRide()">Find Driver</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card p-4">
                        <h4>Ride Status</h4>
                        <div id="customerRideStatus" class="alert alert-secondary">No active ride.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="driverDashboard" class="dashboard">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üöò Driver Panel</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="updateDriverStatus('online')">Go Online</button>
                    <button class="btn btn-secondary" onclick="updateDriverStatus('offline')">Go Offline</button>
                </div>
            </div>
            
            <div class="card p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Available Jobs</h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="fetchAvailableRides()">üîÑ Refresh</button>
                </div>
                <div id="ridesList" class="list-group">
                    <div class="text-center text-muted py-3">Click Refresh to find passengers...</div>
                </div>
            </div>
        </div>

        <div id="adminDashboard" class="dashboard">
            <h2 class="mb-4">üõ°Ô∏è Admin Control</h2>
            <div class="card p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h4>User Management</h4>
                    <button class="btn btn-primary btn-sm" onclick="fetchUsers()">Load All Users</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="regCustomerModal"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">New Customer</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <input id="rcName" class="form-control mb-2" placeholder="Full Name">
            <input id="rcEmail" class="form-control mb-2" placeholder="Email">
            <input id="rcPass" type="password" class="form-control mb-2" placeholder="Password">
            <input id="rcPhone" class="form-control mb-2" placeholder="Phone Number">
            <button class="btn btn-primary w-100" onclick="registerUser('customer')">Sign Up</button>
        </div>
    </div></div></div>

    <div class="modal fade" id="regDriverModal"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">New Driver</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <input id="rdName" class="form-control mb-2" placeholder="Full Name">
            <input id="rdEmail" class="form-control mb-2" placeholder="Email">
            <input id="rdPass" type="password" class="form-control mb-2" placeholder="Password">
            <input id="rdVehicle" class="form-control mb-2" placeholder="Vehicle (e.g. Red Myvi)">
            <button class="btn btn-success w-100" onclick="registerUser('driver')">Sign Up</button>
        </div>
    </div></div></div>

    <div class="modal fade" id="regAdminModal"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">New Admin</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <input id="raName" class="form-control mb-2" placeholder="Full Name">
            <input id="raEmail" class="form-control mb-2" placeholder="Email">
            <input id="raPass" type="password" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-secondary w-100" onclick="registerUser('admin')">Sign Up</button>
        </div>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let userRole = localStorage.getItem('role');

        // Check login on load
        if(token) showDashboard();

        // --- AUTH ---
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if(res.ok) {
                    token = data.token;
                    userRole = data.role;
                    localStorage.setItem('token', token);
                    localStorage.setItem('role', userRole);
                    localStorage.setItem('email', email);
                    showDashboard();
                } else alert(data.error);
            } catch(e) { console.error(e); alert("Server error. Is Node running?"); }
        }

        async function registerUser(type) {
            let body = {};
            let url = `${API_URL}/auth/register/${type}`;
            
            if(type === 'customer') {
                body = {
                    name: document.getElementById('rcName').value,
                    email: document.getElementById('rcEmail').value,
                    password: document.getElementById('rcPass').value,
                    phone: document.getElementById('rcPhone').value
                };
            } else if (type === 'driver') {
                body = {
                    name: document.getElementById('rdName').value,
                    email: document.getElementById('rdEmail').value,
                    password: document.getElementById('rdPass').value,
                    vehicleDetails: document.getElementById('rdVehicle').value
                };
            } else { // admin
                body = {
                    name: document.getElementById('raName').value,
                    email: document.getElementById('raEmail').value,
                    password: document.getElementById('raPass').value
                };
            }

            const res = await fetch(url, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if(res.ok) {
                alert("Registered! Please log in.");
                location.reload();
            } else alert(data.error);
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function showDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('logoutBtn').classList.remove('d-none');
            document.getElementById('userInfo').innerText = `Logged in: ${localStorage.getItem('email')}`;

            if(userRole === 'customer') document.getElementById('customerDashboard').style.display = 'block';
            else if(userRole === 'driver') {
                document.getElementById('driverDashboard').style.display = 'block';
                fetchAvailableRides();
            }
            else if(userRole === 'admin') document.getElementById('adminDashboard').style.display = 'block';
        }

        // --- CUSTOMER ---
        async function requestRide() {
            const body = {
                pickupLocation: document.getElementById('pickup').value,
                dropoffLocation: document.getElementById('dropoff').value,
                distanceKm: parseFloat(document.getElementById('distance').value)
            };
            const res = await fetch(`${API_URL}/rides`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if(res.ok) {
                document.getElementById('customerRideStatus').innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Ride Requested!</strong><br>
                        Fare: RM ${data.fare}<br>
                        Status: Searching for driver...
                    </div>`;
            } else alert(data.error);
        }

        // --- DRIVER ---
        async function updateDriverStatus(status) {
            const res = await fetch(`${API_URL}/drivers/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status })
            });
            alert((await res.json()).message);
        }

        async function fetchAvailableRides() {
            const res = await fetch(`${API_URL}/rides/available`, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            const list = document.getElementById('ridesList');
            list.innerHTML = '';
            
            if(data.error) { list.innerHTML = `<div class="text-danger">${data.error}</div>`; return; }
            if(!data.length) { list.innerHTML = `<div class="p-3 text-muted">No pending rides.</div>`; return; }

            data.forEach(ride => {
                list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>From:</strong> ${ride.pickupLocation}<br>
                        <strong>To:</strong> ${ride.dropoffLocation}<br>
                        <span class="badge bg-success">Fare: RM ${ride.estimatedFare}</span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="acceptRide('${ride._id}')">Accept</button>
                </div>`;
            });
        }

        async function acceptRide(id) {
            const res = await fetch(`${API_URL}/rides/${id}/accept`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                alert("Ride Accepted! Go pick them up.");
                fetchAvailableRides();
            } else alert((await res.json()).error);
        }

        // --- ADMIN ---
        async function fetchUsers() {
            const res = await fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            const allUsers = [...data.customers, ...data.drivers, ...data.admins];
            allUsers.forEach(u => {
                tbody.innerHTML += `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td><span class="badge bg-secondary">${u.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="blockUser('${u._id}', ${!u.isBlocked})">
                            ${u.isBlocked ? 'Unblock' : 'Block'}
                        </button>
                    </td>
                </tr>`;
            });
        }
        
        async function blockUser(id, isBlocked) {
            await fetch(`${API_URL}/admin/users/${id}/block`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ isBlocked })
            });
            fetchUsers();
        }
    </script>
</body>
</html>